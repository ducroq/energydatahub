name: Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    name: Run Tests with Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests with coverage
      run: |
        python -m pytest tests/ -v --cov=utils --cov=energy_data_fetchers --cov=weather_data_fetchers --cov-report=term --cov-report=xml

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.13'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        verbose: true

    - name: Check for malformed timestamps
      run: |
        # Ensure test files don't contain references to malformed timestamps
        if grep -r '+00:09\|+00:18' tests/; then
          echo "ERROR: Test files contain malformed timestamp references"
          exit 1
        fi
        echo "✓ No malformed timestamp references found"

    - name: Run critical timezone tests only
      run: |
        python -m pytest tests/ -v -m critical

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check for syntax errors
      run: |
        python -m py_compile $(find . -name "*.py" -not -path "*/tests/*" -not -path "*/.venv/*" -not -path "*/venv/*")

    - name: Validate project structure
      run: |
        # Check that required files exist
        test -f pytest.ini || (echo "ERROR: pytest.ini missing" && exit 1)
        test -f requirements.txt || (echo "ERROR: requirements.txt missing" && exit 1)
        test -f CLAUDE.md || (echo "ERROR: CLAUDE.md missing" && exit 1)
        test -d tests/unit || (echo "ERROR: tests/unit directory missing" && exit 1)
        test -d tests/integration || (echo "ERROR: tests/integration directory missing" && exit 1)
        echo "✓ Project structure validated"
